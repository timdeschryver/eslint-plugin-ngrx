import { writeFileSync } from 'fs'
import { join } from 'path'
import { format, resolveConfig } from 'prettier'
import { rules } from '../src/rules'
import { RuleModule } from '../src/utils/types'

const prettierConfig = resolveConfig.sync(__dirname)

const RULE_NAME_PREFIX = 'ngrx/'
const CONFIG_DIRECTORY = './src/configs/'

const getRules = (
  predicate: (rule: RuleModule) => boolean,
  setting = (rule: RuleModule) => rule.meta.docs?.recommended || 'warn',
) =>
  Object.entries(rules).reduce((rules, [ruleName, rule]) => {
    if (predicate(rule)) {
      rules[`${RULE_NAME_PREFIX}${ruleName}`] = setting(rule)
    }
    return rules
  }, {} as Record<string, string>)

const rxjsRules = {
  'rxjs/no-cyclic-action': 'warn',
  'rxjs/no-unsafe-catch': 'warn',
  'rxjs/no-unsafe-first': 'warn',
  'rxjs/no-unsafe-switchmap': 'warn',
}

writeConfig('recommended', {
  ...getRules((rule) => !!rule.meta.docs?.recommended),
  ...rxjsRules,
})

writeConfig('all', {
  ...getRules(() => true),
  ...rxjsRules,
})

writeConfig('strict', {
  ...getRules(
    () => true,
    () => 'error',
  ),
  ...rxjsRules,
})

writeConfig(
  'store',
  {
    ...getRules((rule) => rule.meta.module === 'store'),
  },
  ['ngrx'],
)

writeConfig(
  'effects',
  {
    ...getRules((rule) => rule.meta.module === 'effects'),
  },
  ['ngrx'],
)

function writeConfig(
  configName: 'recommended' | 'all' | 'store' | 'effects' | 'strict',
  configRules: Record<string, string>,
  plugins = ['ngrx', 'rxjs'],
) {
  const code = `
/**
 * DO NOT EDIT
 *
 * This file is automatically generated (as a pre-commit step)
 */

export = {
  plugins: ${JSON.stringify(plugins)},
  rules: ${JSON.stringify(configRules)},
}
`
  const config = format(code, {
    parser: 'typescript',
    ...prettierConfig,
  })
  writeFileSync(join(CONFIG_DIRECTORY, `${configName}.ts`), config)
}
